<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Markdown Cleanup - Cross Browser</title>
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        margin: 2rem;
        background: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .test-item {
        margin: 1rem 0;
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .test-input {
        background: #f8f8f8;
        padding: 0.5rem;
        font-family: monospace;
        border-radius: 4px;
        margin-bottom: 0.5rem;
      }
      .test-output {
        background: #e8f5e8;
        padding: 0.5rem;
        border-radius: 4px;
        min-height: 20px;
      }
      .browser-info {
        background: #e8f4f8;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 2rem;
      }
      .run-test {
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 1rem 0;
      }
      .run-test:hover {
        background: #45a049;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üß™ Test Markdown Cleanup - Cross Browser</h1>

      <div class="browser-info">
        <h3>üåê Browser Information</h3>
        <div id="browserInfo"></div>
      </div>

      <button class="run-test" onclick="runAllTests()">
        üöÄ Jalankan Semua Test
      </button>

      <div id="testResults"></div>
    </div>

    <script>
      // Browser detection utility (copy dari discussion.html)
      function getBrowserInfo() {
        const userAgent = navigator.userAgent;
        const isEdge = /Edge\/|Edg\//.test(userAgent);
        const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
        const isChrome =
          /Chrome/.test(userAgent) && !/Edge\/|Edg\//.test(userAgent);
        const isFirefox = /Firefox/.test(userAgent);

        return { isEdge, isSafari, isChrome, isFirefox, userAgent };
      }

      // Enhanced markdown cleanup function (copy dari chat-history-manager.js yang sudah diperbaiki)
      function stripHtmlAndMarkdown(text) {
        if (!text || typeof text !== "string") return "";

        try {
          let cleaned = text;

          // Remove HTML tags and entities
          cleaned = cleaned.replace(/<[^>]*>/g, "");
          cleaned = cleaned.replace(/&[a-zA-Z0-9#]+;/g, "");

          // Remove markdown formatting (comprehensive)
          // Bold and italic combinations
          cleaned = cleaned.replace(/\*\*\*([^*]+)\*\*\*/g, "$1"); // Bold + Italic
          cleaned = cleaned.replace(/___([^_]+)___/g, "$1"); // Bold + Italic underscore
          cleaned = cleaned.replace(/\*\*([^*]+)\*\*/g, "$1"); // Bold
          cleaned = cleaned.replace(/__([^_]+)__/g, "$1"); // Bold underscore
          cleaned = cleaned.replace(/\*([^*]+)\*/g, "$1"); // Italic
          cleaned = cleaned.replace(/_([^_]+)_/g, "$1"); // Italic underscore

          // Remove strikethrough
          cleaned = cleaned.replace(/~~([^~]+)~~/g, "$1");

          // Remove headers
          cleaned = cleaned.replace(/^#{1,6}\s+/gm, "");

          // Remove links (keep the link text)
          cleaned = cleaned.replace(/\[([^\]]+)\]\([^)]*\)/g, "$1");
          cleaned = cleaned.replace(/\[([^\]]+)\]\[[^\]]*\]/g, "$1");

          // Remove images (replace with text indicator)
          cleaned = cleaned.replace(/!\[([^\]]*)\]\([^)]*\)/g, "[Gambar: $1]");

          // Remove code blocks and inline code
          cleaned = cleaned.replace(/```[\s\S]*?```/g, "[Blok Kode]");
          cleaned = cleaned.replace(/~~~/g, "[Blok Kode]");
          cleaned = cleaned.replace(/`([^`]+)`/g, "$1");

          // Remove blockquotes
          cleaned = cleaned.replace(/^>\s+/gm, "");

          // Remove lists (keep content)
          cleaned = cleaned.replace(/^[\s]*[-*+]\s+/gm, "‚Ä¢ ");
          cleaned = cleaned.replace(/^[\s]*\d+\.\s+/gm, "");

          // Remove horizontal rules
          cleaned = cleaned.replace(/^[-*_]{3,}$/gm, "");
          cleaned = cleaned.replace(/^={3,}$/gm, "");

          // Remove tables (replace with indicator)
          cleaned = cleaned.replace(/\|.*\|/g, "[Tabel]");

          // Clean up whitespace and newlines
          cleaned = cleaned.replace(/\n\s*\n\s*\n/g, "\n\n"); // Max 2 consecutive newlines
          cleaned = cleaned.replace(/\n\s*\n/g, "\n"); // Single newline for paragraphs
          cleaned = cleaned.replace(/^\s+|\s+$/g, ""); // Trim start/end
          cleaned = cleaned.replace(/[ \t]+/g, " "); // Multiple spaces to single space

          // Handle special characters that might cause issues in Edge
          cleaned = cleaned.replace(/[\u200B-\u200D\uFEFF]/g, ""); // Zero-width spaces
          cleaned = cleaned.replace(/\u00A0/g, " "); // Non-breaking space to regular space

          return cleaned;
        } catch (error) {
          console.warn("Error cleaning markdown text:", error);
          // Fallback to simple HTML tag removal
          return text
            .replace(/<[^>]*>/g, "")
            .replace(/\s+/g, " ")
            .trim();
        }
      }

      // Edge-specific additional cleaning (copy dari discussion.html)
      function ensureCleanText(text) {
        if (!text || typeof text !== "string") return "";

        const browser = getBrowserInfo();

        try {
          let cleaned = text;

          // Edge memerlukan pembersihan ekstra
          if (browser.isEdge) {
            // Pembersihan khusus Edge untuk markdown yang stubborn
            cleaned = cleaned.replace(/\*{1,3}([^*]+)\*{1,3}/g, "$1");
            cleaned = cleaned.replace(/_{1,3}([^_]+)_{1,3}/g, "$1");
            cleaned = cleaned.replace(/#{1,6}\s+/g, "");
            cleaned = cleaned.replace(/```[\s\S]*?```/g, "[Kode]");
            cleaned = cleaned.replace(/`([^`]+)`/g, "$1");
            cleaned = cleaned.replace(/\[([^\]]+)\]\([^)]*\)/g, "$1");
            cleaned = cleaned.replace(/!\[([^\]]*)\]\([^)]*\)/g, "[Gambar]");
            cleaned = cleaned.replace(/^>\s+/gm, "");
            cleaned = cleaned.replace(/^[-*+]\s+/gm, "‚Ä¢ ");
            cleaned = cleaned.replace(/\|.*\|/g, "[Tabel]");
          }

          // Safari handling
          if (browser.isSafari) {
            cleaned = cleaned.replace(/[\u200B-\u200D\uFEFF]/g, "");
            cleaned = cleaned.replace(/\u00A0/g, " ");
          }

          // General cleanup untuk semua browser
          cleaned = cleaned.replace(/<[^>]*>/g, ""); // HTML tags
          cleaned = cleaned.replace(/&[a-zA-Z0-9#]+;/g, ""); // HTML entities
          cleaned = cleaned.replace(/\s+/g, " "); // Multiple spaces
          cleaned = cleaned.trim();

          // Fallback jika masih ada masalah
          if (
            cleaned.includes("*") ||
            cleaned.includes("#") ||
            cleaned.includes("`")
          ) {
            console.warn(
              "Markdown tags still present after cleaning:",
              cleaned
            );
            cleaned = cleaned.replace(/[*#`_~\[\]()]/g, "");
          }

          return cleaned;
        } catch (error) {
          console.error("Error cleaning text:", error);
          return text
            .replace(/<[^>]*>/g, "")
            .replace(/[*#`_~\[\]()]/g, "")
            .trim();
        }
      }

      // Test cases
      const testCases = [
        {
          name: "Basic Bold/Italic",
          input: "This is **bold** and *italic* text",
        },
        {
          name: "Headers",
          input: "# Header 1\n## Header 2\n### Header 3",
        },
        {
          name: "Code Blocks",
          input: "Here is `inline code` and:\n```\ncode block\n```",
        },
        {
          name: "Links",
          input: "Visit [Google](https://google.com) for search",
        },
        {
          name: "Images",
          input: "![Alt text](image.jpg) and ![](image2.png)",
        },
        {
          name: "Lists",
          input: "- Item 1\n- Item 2\n1. Numbered\n2. List",
        },
        {
          name: "Mixed Complex",
          input:
            "# Title\n\n**Bold** and *italic* with `code` and [link](url)\n\n> Blockquote\n\n- List item\n\n```\ncode block\n```",
        },
        {
          name: "HTML Tags",
          input: "<p>HTML <strong>bold</strong> and <em>italic</em></p>",
        },
        {
          name: "Special Characters",
          input: "Text with\u00A0non-breaking\u200Bspaces\uFEFF",
        },
        {
          name: "Tables",
          input:
            "| Column 1 | Column 2 |\n|----------|----------|\n| Data 1   | Data 2   |",
        },
      ];

      function displayBrowserInfo() {
        const info = getBrowserInfo();
        const infoDiv = document.getElementById("browserInfo");

        let browserName = "Unknown";
        if (info.isEdge) browserName = "Microsoft Edge";
        else if (info.isSafari) browserName = "Safari";
        else if (info.isChrome) browserName = "Chrome";
        else if (info.isFirefox) browserName = "Firefox";

        infoDiv.innerHTML = `
                <strong>Browser:</strong> ${browserName}<br>
                <strong>User Agent:</strong> ${info.userAgent}<br>
                <strong>Detection:</strong> Edge: ${info.isEdge}, Safari: ${info.isSafari}, Chrome: ${info.isChrome}, Firefox: ${info.isFirefox}
            `;
      }

      function runAllTests() {
        const resultsDiv = document.getElementById("testResults");
        resultsDiv.innerHTML = "";

        testCases.forEach((testCase, index) => {
          const testDiv = document.createElement("div");
          testDiv.className = "test-item";

          const result1 = stripHtmlAndMarkdown(testCase.input);
          const result2 = ensureCleanText(testCase.input);

          testDiv.innerHTML = `
                    <h4>Test ${index + 1}: ${testCase.name}</h4>
                    <div class="test-input">
                        <strong>Input:</strong><br>
                        <code>${testCase.input.replace(/\n/g, "\\n")}</code>
                    </div>
                    <div class="test-output">
                        <strong>stripHtmlAndMarkdown():</strong><br>
                        "${result1}"
                    </div>
                    <div class="test-output">
                        <strong>ensureCleanText():</strong><br>
                        "${result2}"
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.9em; color: #666;">
                        <strong>Success:</strong> ${
                          result1.includes("*") ||
                          result1.includes("#") ||
                          result1.includes("`")
                            ? "‚ùå Tags remain"
                            : "‚úÖ Clean"
                        }
                        | ${
                          result2.includes("*") ||
                          result2.includes("#") ||
                          result2.includes("`")
                            ? "‚ùå Tags remain"
                            : "‚úÖ Clean"
                        }
                    </div>
                `;

          resultsDiv.appendChild(testDiv);
        });
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        displayBrowserInfo();
        console.log("üß™ Test page loaded");
      });
    </script>
  </body>
</html>
